<!DOCTYPE html>
<html lang="ja">
<head>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
  <script type="text/javascript" src="./js/lib/jquery-1.11.2.js"></script>
  <script type="text/javascript" src="./js/lib/underscore.js"></script>
  <script type="text/javascript" src="./js/lib/backbone.js"></script>
  <script type="text/javascript">
    jQuery(function($) {
      var MyApp = {};

      MyApp.main = function() {
        // Modelオブジェクトを生成する。
        var personList = new MyApp.PersonList();
        var personInput = new MyApp.Person();

        var tableFormView = new MyApp.TableFormView({
          collection: personList
        });
        var inputFormView = new MyApp.InputFormView({
          model: personInput,
          personList: personList
        });

        // フェッチしてコレクションの初期データを生成する。
        personList.fetch().then(function() {
          $('#tableFormBlock').append(tableFormView.render().$el);
          $('#inputFormBlock').append(inputFormView.render().$el);
        });
      }

      // PersonのModel
      MyApp.Person = Backbone.Model.extend({
        defaults: {
          personId: '',
          personName: '',
          age: '',
          gender: ''
        },
        idAttribute: 'personId',
        url: 'http://localhost:8080/rs_person_server/persons'
      });

      // Modelを定義する。
      // Personのコレクション
      MyApp.PersonList = Backbone.Collection.extend({
        model: MyApp.Person, // 先にModelが宣言されている必要あり
        url: 'http://localhost:8080/rs_person_server/persons',
        getMaxPersonId: function() {
          if (this.size() == 0) {
            return 0;
          } else {
            var maxPerson = this.max(function(person){
              return person.get('personId');
            });
            return parseInt(maxPerson.get('personId'));
          }
        }
      });

      // ViewModelを定義する。
      MyApp.InputFormView = Backbone.View.extend({
        initialize: function(options) {
          this.model = options.model;
          this.personList = options.personList;
          this.listenTo(this.personList, 'edit', function(personRow) {
            this.model = personRow;
            this.render();
          });
        },
        events: {
          'submit #inputForm': 'submit'
        },
        render: function() {
          var template = $('#inputForm-tmpl').html();
          var compiled = _.template(template);
          var html = compiled(this.model.toJSON());
          this.$el.html(html);
          return this;
        },
        submit: function(event) {
          event.preventDefault(); // これでFORMのSUBMITでリロードが走らなくなる?
          var personId = this.$('#personId').val();
          var createMode = false;
          if (personId == '') {
            createMode = true;
            personId = this.personList.getMaxPersonId() + 1;
          }
          this.model.set({personId: personId});
          this.model.set({personName: this.$('#personName').val()});
          this.model.set({age: this.$('#age').val()});
          this.model.set({gender: this.$('#gender').val()});
          // モデルの追加（自動的に、IDが同じだったら更新、IDが違っていれば挿入される！）
          // クローンを入れないと、この先のクリア処理（set{personId: ''}）でpersonListの中までクリアされちゃう。
          this.personList.add(this.model.clone(), {merge: true});
          this.personList.trigger('update');

          if (createMode) {
            this.model.save(this.model.attributes, {
              type: 'POST',
              wait: false
            });
          } else {
            this.model.save(this.model.attributes, {
              type: 'PUT',
              wait: false
            });
          }
          this.model.set({personId: '', personName: '', age: '', gender: ''});
          this.render();
        }
      });

      // モデル用のView
      MyApp.RowView = Backbone.View.extend({
        tagName: 'tr',
        initialize: function(options) {
          this.model = options.model;
        },
        events: {
          'click button[name="edit"]': 'editRow',
          'click button[name="delete"]': 'removeRow'
        },
        render: function() {
          var template = $('#row-tmpl').html();
          var compiled = _.template(template);
          var html = compiled(this.model.toJSON());
          this.$el.append(html);
          return this;
        },
        editRow: function(event) {
          this.model.collection.trigger('edit', this.model.clone());
        },
        removeRow: function(event) {
          this.model.collection.remove(this.model); // モデルの削除
          this.model.destroy({
              url: 'http://localhost:8080/rs_person_server/persons/remove',
              type: 'POST',
              data: JSON.stringify(this.model.attributes), // saveと同じようにtoJSON()にしたがNGだった
              contentType: 'application/json; charset=UTF-8',
              wait: false
          });
        }
      });

      // コレクション用のView
      MyApp.TableFormView = Backbone.View.extend({
        initialize: function(options) {
          this.collection = options.collection;
          this.listenTo(this.collection, 'update', this.reRender);
          this.listenTo(this.collection, 'remove', this.reRender);
        },
        render: function() {
          var template = $('#tableForm-tmpl').html();
          this.$el.append(template);
          this.renderRow();
          return this;
        },
        renderRow: function() {
          var self = this;
          self.collection.each(function(personRow) {
            var rowView = new MyApp.RowView({
              model: personRow
            });
            self.$('#tbodyContainer').append(rowView.render().$el); // ループ処理の中ではthisの意味が変わってしまう模様
          });
        },
        reRender: function() {
          this.$el.empty();
          this.render();
        }
      });

      new MyApp.main();
    });
  </script>
  <script type="text/template" id="inputForm-tmpl">
    <form id="inputForm">
      <label for="personId">ID</label>
      <input type="text" id="personId" value="<%= personId%>" size="3"
             readonly="true" />
      <label for="personName">名前</label>
      <input type="text" id="personName" value="<%= personName%>" size="10"/>
      <label for="age">年齢</label>
      <input type="text" id="age" value="<%= age%>" size="3"/>
      <label for="gender">性別</label>
      <select id="gender" name="gender">
        <option value=""></option>
        <option value="male" <%= gender === 'male' ? "selected" : "" %>>男性</option>
        <option value="female" <%= gender === 'female' ? "selected" : "" %>>女性</option>
      </select>
      <button id="submitButton">登録</button>
    </form>
  </script>
  <script type="text/template" id="tableForm-tmpl">
    <form id="tableForm">
      <table id="personTable" border="1">
        <thead>
        <th>ID</th>
        <th>名前</th>
        <th>年齢</th>
        <th>性別</th>
        <th>編集</th>
        <th>削除</th>
        </thead>
        <tbody id="tbodyContainer">
        </tbody>
      </table>
    </form>
  </script>
  <script type="text/template" id="row-tmpl">
    <td><%= personId %></td>
    <td><%= personName %></td>
    <td><%= age %></td>
    <td><%= gender != '' ? gender == 'male' ? '男性' : '女性': '' %></td>
    <td>
      <button type="button" name="edit">編集</button>
    </td>
    <td>
      <button type="button" name="delete">削除</button>
    </td>
  </script>
</head>
<body>
<div id="inputFormBlock"></div>
<hr/>
<div id="tableFormBlock"></div>
</body>
</html>